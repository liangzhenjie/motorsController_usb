#include "mediator.h"
#include "communication.h"
#include "autorecoginze.h"
#include "proxyparser.h"
#include "dataUtil.h"
#include "innfosproxy.h"
#include <QDebug>
#include "motordata.h"

Mediator * Mediator::m_pInstance = nullptr;
Mediator *Mediator::getInstance()
{
    if(!m_pInstance)
    {
        m_pInstance = new Mediator;
    }

    return m_pInstance;
}

void Mediator::destroyAllStaticObjects()
{
    //MotorMgr::autoDestroy();
    AutoRecoginze::autoDestroy();
    Communication::autoDestroy();
    DataUtil::autoDestroy();
    ProxyParser::autoDestroy();
    MotorDataMgr::autoDestroy();
    qDebug() << "delete";
    if(m_pInstance)
        delete m_pInstance;
    m_pInstance = nullptr;
}

void Mediator::autoRecognize()
{
#ifdef TEST_DEBUG
    connect(Communication::getInstance(),&Communication::request,ProxyWatcher::getInstance(),&ProxyWatcher::addSendItem);
#endif
    AutoRecoginze::getInstance()->startRecognize(bRetry);
}

void Mediator::onCanConnected(quint8 nCommunicationUnitId)
{
    Communication::getInstance()->setUnitConnectionStatus(nCommunicationUnitId,UserDefine::CAN_CONNECTED);
}

void Mediator::SendRequest(const QByteArray &buf)
{
    quint8 nId = buf.at(1);
    Communication::getInstance()->sendData(nId,buf);
}

void Mediator::Handshake(quint32 nDeviceId, bool bSuccess)
{
    motorDataMgrInstance->responseHeart(nDeviceId,bSuccess);
}

void Mediator::SetCurParam(const int nDeviceID, const QVariant value, const int nProxyId)
{
    motorDataMgrInstance->setMotorDataAttrByProxy(nDeviceID,nProxyId,value);//data from device
}

void Mediator::SetSucceed(const quint8 nDeviceId, const int nProxyId)
{

    switch (nProxyId) {
    case D_SET_DEVICE_ID:
        Communication::getInstance()->changeUnitRelateId(motorDataMgrInstance->getOldDeviceId(nDeviceId),nDeviceId);
        motorDataMgrInstance->requestSuccessfully(nDeviceId,nProxyId);
        break;
    default:
        motorDataMgrInstance->requestSuccessfully(nDeviceId,nProxyId);
        break;
    }
    if(m_pRequestCallback)
        m_pRequestCallback(nDeviceId,nProxyId,1);
}

void Mediator::SetFailed(const int nParam)
{
    Q_UNUSED(nParam);
}

void Mediator::reciveMotorInfo(quint8 communicateUnitId, const quint32 nDeviceMac, const quint8 nDeviceId)
{
    AutoRecoginze::getInstance()->addMototInfo(nDeviceId,nDeviceMac);
    Communication::getInstance()->addRelateIdToUnit(communicateUnitId,nDeviceId);
    Communication::getInstance()->setUnitConnectionStatus(communicateUnitId,UserDefine::CAN_CONNECTED|UserDefine::MOTOR_CONNECTED);
}

void Mediator::receiveNoDataProxy(const int nDeviceID)
{
    switch (nDeviceID) {
    case D_CHART_DATA_STATR:
        emit startNewPeriodChart();
        break;
    default:
        break;
    }
}

//void Mediator::saveDataToDevice()
//{
//    MotorData * pMotor = MotorMgr::getInstance()->getMotorByDeviceId(nDeviceId);
//    if(pMotor)
//        InnfosProxy::SendProxy(pMotor->deviceId(),D_SAVE_PARAM);
//    QVector<MotorData *> selMotors = MotorMgr::getInstance()->allSelectedMotors();
//    foreach (MotorData * pMotor, selMotors)
//    {
//       InnfosProxy::SendProxy(pMotor->deviceId(),D_SAVE_PARAM);
//    }
//}


void Mediator::recognizeFinished(QMap<quint8, quint32> motorsInfo)
{
    motorDataMgrInstance->AddMotorsData(motorsInfo);//add to logic manager
    Communication::getInstance()->removeUnAvailablePorts();
    m_sRecognizeFinished.s_Emit();
}

void Mediator::setRequestCallback(requestCallback pRequestCallback)
{
    m_pRequestCallback = pRequestCallback;
}

void Mediator::setErrorInfoFunc(errorInfoFunc func)
{
    m_pErrorFunc = func;
}

void Mediator::checkServosStatus()
{
    //MotorMgr::getInstance()->CheckServosSwitch(); //to do
}

void Mediator::response(quint8 nUnitId, const QByteArray buf)
{
    ProxyParser::getInstance()->parse(nUnitId,buf);
}

void Mediator::reconnectDevice(quint8 nDeviceId)
{
    motorDataMgrInstance->setMotorDataAttrByUser(nDeviceId,MotorData::ONLINE_STATUS,UserDefine::Status_Online);
}

void Mediator::errorOccur(quint8 nDeviceId, quint16 errorId, QString errorStr)
{

    if(m_pErrorFunc)
    {
        qDebug() << "error";
        m_pErrorFunc(nDeviceId,errorId,errorStr.toStdString());
    }
}

Mediator::Mediator(QObject *parent):
    QObject(parent),
    m_pRecognizeCallback(nullptr),
    m_pRequestCallback(nullptr),
    m_pErrorFunc(nullptr)
{
    connect(Communication::getInstance(),&Communication::response,this,&Mediator::response);
    connect(Communication::getInstance(),&Communication::connectionError,this,&Mediator::errorOccur);
    connect(motorDataMgrInstance,&MotorDataMgr::errorOccured,this,&Mediator::errorOccur);
}


